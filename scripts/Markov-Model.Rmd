---
title: "UCSF Stages Data - Grouped into Moderate, Severe, and Dead"
author: "Steph Reynolds (Stephanie.Reynolds@ucsf.edu)"
date: "`r format(Sys.time(), '%b %d, %Y  %H:%M %p')`"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background

## Project 
MINDSCAPE: Modeling of infectious network dynamics for surveillance, control and prevention enhancement

## Description
This file imports demographic and staging data and returns a dataset indicating each patient's `max_stage`, `date_adm`, `date_disc`, `los`, `stage_adm`, `stage_disc`, `days_to_disc`. This file prepares the staging data for analysis. 

## Source Data
  - Demographics and Daily Covid Stage Data (`dm_covid_stg_11.08.2021.csv`)
    + This file contains data on patient demographics and COVID stage (based on WHO Clinical Progression Scale, which aims to capture patient clinical trajectory and resource usage over the course of the clinical illness -- in this case, COVID-19).
    + Each row represents one day per patient in hospital. 

# Load required packages
```{r Load required packages}
library(here)
library(tidyverse)
library(forcats)
```

# Import and preview data 
```{r Import and preview data, echo=F}
df <- read_csv(here("data", "dm_stg_clean_11.08.21.csv"))

glimpse(df)
```

```{r}
df$stg.cat <- fct_collapse(as.character(df$stage),
                           "Moderate" = c("4", "5"),
                           "Severe" = c("6", "7", "8", "9"),
                           "Dead" = "10")

df$stg.cat <- factor(df$stg.cat, levels=c("Moderate", "Severe", "Dead"))

levels(df$stg.cat)

markov_df <- df %>% 
  group_by(ID) %>% 
  mutate(stgcat_disc = stg.cat[date == date_disc],
         stgcat_adm = stg.cat[date == date_adm]) %>% 
  select(ID, date, stg.cat) #, stgcat_disc, stgcat_adm)

a <- df %>% 
 group_by(ID) %>% 
  mutate(lag = stg.cat - lag(stg.cat))

##################################################################

#df_copy <- df %>% 
  filter(death == "No") %>% 
  group_by(ID) %>% 
  summarise(date_disc) %>% 
  mutate(date_disc = date_disc + 1,
         stg.cat = 0) %>% 
  bind_rows(df, .) %>% 
  distinct()

#df <- df %>% 
  left_join(df_copy, by = "ID") %>% 
  arrange(ID, date)

```

## For each patient who died, bind an additional row where date==death_date, DEATH==1, and STAGE==10
```{r Create extra row for patients with missing row on date of death, and bind to last row}
bin_clin_scen_df <- bin_clin_scen_df %>%
  filter(end_in_death == "Yes") %>% 
  group_by(ID) %>% 
  filter(death_date != max(date)) %>% 
  summarise(date = max(date)) %>%
  mutate(date = date + 1,
         DEATH = 1,
         STAGE = 10, .) %>% 
   bind_rows(bin_clin_scen_df, .) %>% 
   arrange(ID)
```

```{r}

```


```{r}

```


```{r}

```


