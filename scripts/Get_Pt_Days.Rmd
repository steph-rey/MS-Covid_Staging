---
title: "Patient-Days Table"
author: "Steph Reynolds (Stephanie.Reynolds@ucsf.edu)"
date: "`r format(Sys.time(), '%b %d, %Y  %H:%M %p')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background

## Project 
MINDSCAPE: Modeling of infectious network dynamics for surveillance, control and prevention enhancement

## Description
This file parses the admit and discharge date from the `dm` dataset and returns an expanded dataset with one row per patient per day of hospitalization. 

## Source Data
  - Demographics and Events Table (`dm_covid.csv`)
    + This file contains data on patient demographics (age, sex, race, ethnicity), time of admission and discharge, time of death (if applicable), length of stay (LOS), and other comorbidities. 

# Load required packages 
```{r Load required packages, message = F}
library(here)
library(tidyverse)
  #library(forcats)
```

# Import and preview data 
```{r Import and preview data, echo=FALSE}
dm <- read_csv(here("data", "dm_covid.csv"))

str(dm)
```

# Create vector of variables to include in final dataset, assign to `vars`
```{r Create vector of variables}
vars <- c("deid_enc_id", "age", "sex", "zip_code", "pat_race", "ethnicity", "smoking", 
          "BMI", "admit_or_transfer_ICU", "end_in_death", "death_time", "admit_time",
          "discharge_time", "hospital_LOS")
```

# Clean and transform `dm` to expanded dataset where each row presents patient-days (each row is one patient per day of hospitalization)
```{r Clean and transform `dm` to expanded dataset where each row represents patient-days}
dm <- dm %>% 
  filter(covid_pos == "Yes" & hospital_LOS > 0) %>%     # Filter dataset where `covid_pos` == 'Yes' & `hospital_LOS` > 0
  select(vars) %>%            # Filter to only include variables in `var` vector
  rename(ID = deid_enc_id, 
         race = pat_race, 
         zip = zip_code,
         LOS = hospital_LOS) %>%      # Parse date from `admit_time` and `discharge_time`
  mutate(admit_date = as.Date(admit_time),
         discharge_date = as.Date(discharge_time),
         death_time = as.POSIXct(death_time, format = "%Y-%m-%d %H:%M:%S"),
         death_date = as.Date(death_time)) %>% 
  group_by(ID) %>%  # Group by 'ID' (unique patient identifier)
  mutate(day_date = list(seq(min(admit_date), max(discharge_date), by = "day"))) %>%    
  unnest(day_date)    # Create new var `day_date` that spans from `admit_date` to `discharge_date` for each patient
```

# Transform and collapse factor variables
```{r Transform and collapse variables, warning = F}
# Transform `sex` to factor
dm$sex <- as.factor(dm$sex)

# Transform `race` to factor, and collapse categories
dm$race <- as.factor(dm$race)

dm$race <- fct_collapse(dm$race,
                        "Other" = c("Other", "American Indian or Alaska Native"),
                        "Unknown" = c("Unknown", "Declined", "Unknown/Declined"),
                        "Native Hawaiian or Other Pacific Islander" = c("Native Hawaiian or Other Pacific Islander", "Other Pacific Islander"))

# Transform `ethnicity` to factor, and collapse categories
dm$ethnicity <- as.factor(dm$ethnicity)

dm$ethnicity <- fct_collapse(dm$ethnicity, 
                             "Unknown" = c("Declined", "Unknown", "Unknown/Declined"))

# Transform `smoking` to factor, and collapse categories
dm$smoking <- as.factor(dm$smoking)

dm$smoking <- fct_collapse(dm$smoking,
                           "Current Smoker" = c("Current Every Day Smoker", "Current Some Day Smoker", "Light Tobacco Smoker",
                                                "Smoker, Current Status Unknown"),
                           "Not Current Smoker" = c("Never Smoker", "Former Smoker", "Passive Smoke Exposure - Never Smoker"),
                           "Smoking Status Unknown" = c("Unknown If Ever Smoked", "NULL"))
```

# Save final `dm` dataset as .Rdata and export as .csv
```{r Save and export final dataset}
write_csv(dm, here("data", "dm_covid_11.08.21.csv"))
save(dm, file = here("data", "dm_covid.Rdata"))
```

# End of Document

