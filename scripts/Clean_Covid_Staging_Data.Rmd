---
title: "Clean Covid Staging Data"
author: "Steph Reynolds (Stephanie.Reynolds@ucsf.edu)"
date: "`r format(Sys.time(), '%b %d, %Y  %H:%M %p')`"
output:
  html_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Background

## Project 
MINDSCAPE: Modeling of infectious network dynamics for surveillance, control and prevention enhancement

## Description
This file cleans the demographics and daily Covid staging data (`dm_covid_stg_11.08.21.csv`) and prepares for analysis (e.g., create new variables and transform variables to proper data type). The resulting dataframe (`df`) is then de-duplicated to create another dataset where each row represents a unique patient (`one_row_per_pt`).

## Source Data
  - Demographics and Daily Covid Stage Data (`dm_covid_stg_11.08.21.csv`)
    + This file contains data on patient demographics and COVID stage (based on WHO Clinical Progression Scale, which aims to capture patient clinical trajectory and resource usage over the course of the clinical illness -- in this case, COVID-19). Needs to be cleaned and pre-processed before preliminary analysis.

# Load required packages
```{r Load required packages, include=F}
library(tidyverse)
```

# Import and preview data 
```{r Import and preview data}
df <- read_csv("/Users/sreynolds2/Documents/GitHub/MS-Covid_Staging/data/dm_covid_stg_11.08.21.csv")

head(df, n=10)
```

# Create new variables

  * `max_stage` --> max stage that patient experienced during hospital stay 
  * `date_adm` --> date that patient was admitted
  * `date_disc` --> date that patient was discharged
  * `death` --> binary indicator of whether patient died in hospital 
  * `DOD` --> date of death 
  * `LOS` --> length of stay in hospitals (in days)
  * `stage_adm` --> stage at which patient in admitted
  * `stage_disc` --> stage at which patient is discharged
  * `days_to_disc` --> number of days until pt is discharged 
  * `severe` --> binary indicator of where stage is severe (stages 6-9)
```{r Create new variables}
df <- df %>% 
  rename(stage = STAGE,
         death = end_in_death,
         DOD = death_date) %>% 
  group_by(ID) %>% 
  mutate(max_stage = max(stage),
         date_adm = min(date),
         date_disc = max(date),
         LOS = round(difftime(date_disc, date_adm, units = 'days'), 1),
         stage_adm = stage[date == date_adm],
         stage_disc = stage[date == date_disc],
         days_to_disc = round(difftime(date_disc, date, units = 'days'), 1),
         severe = ifelse(stage >= 6, 1, 0)) %>% 
  select(-DEATH)
```

# Transform variables to proper data type
```{r Transform variables to proper data type}
# Transform variables to integer or factor type

# CREATE FUNCTION TO TRANSFORM ALL VARS TO FACTOR TYPE! THIS WILL SAVE TIME IN FUTURE.
df <- df %>% 
  mutate(age = as.integer(age),
         sex = as.factor(sex),
         race = as.factor(race),
         ethnicity = as.factor(ethnicity),
         smoking = as.factor(smoking),
         death = as.factor(death),
         LOS = as.integer(LOS),
         stage = as.factor(stage), 
         max_stage = as.factor(max_stage),
         stage_adm = as.factor(stage_adm),
         stage_disc = as.factor(stage_disc),
         days_to_disc = as.integer(days_to_disc),
         severe = as.factor(severe))
```

# Preview final `df` dataset and save as csv file and Rdata 
```{r Save dataframe as csv file}
# Preview dataset
head(df, n=10)

# Save as csv
write_csv(df, "/Users/sreynolds2/Documents/GitHub/MS-Covid_Staging/data/dm_stg_clean_11.08.21.csv")
```

# Create dataset with one unique patient per row (remove duplicates from `df`)
```{r}
one_row_per_pt <- df %>% 
  distinct(ID, .keep_all = TRUE) %>% 
  select(-c(date, stage, days_to_disc, severe))
```

# Preview `one_row_per_pt` dataset and save as csv file
```{r}
# Preview dataset
head(one_row_per_pt, n=10)

# Save as csv
write_csv(one_row_per_pt, "/Users/sreynolds2/Documents/GitHub/MS-Covid_Staging/data/dm_stg_unique_pt_11.08.21.csv")
```

# End of Document 
